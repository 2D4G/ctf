–û–∫–µ–π üëç —Ç–æ–≥–¥–∞ –∏–¥—ë–º —Å—Ç—Ä–æ–≥–æ –ø–æ "–∂–µ–ª–µ–∑–Ω—ã–º" —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º, –±–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤.
–ù–∞ —á–∏—Å—Ç–æ–º Linux (–∏ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ä–æ—É—Ç–µ—Ä–æ–≤ Cisco/Mikrotik/Juniper) –∏–∑ –∫–æ—Ä–æ–±–∫–∏ –µ—Å—Ç—å –¥–≤–∞ –±–∞–∑–æ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–∞:


---

üìå VPN –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤

1. IPsec (XFRM + setkey) ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —è–¥—Ä–æ Linux

Linux —è–¥—Ä–æ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å—Ç–µ–∫ IPsec (—á–µ—Ä–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º—É XFRM).
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥—É ip xfrm (–Ω–æ–≤—ã–π –º–µ—Ç–æ–¥) –∏–ª–∏ setkey (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥, —á–µ—Ä–µ–∑ ipsec-tools ‚Äî –Ω–æ —ç—Ç–æ –ø–∞–∫–µ—Ç, —Ç–∞–∫ —á—Ç–æ –æ—Å—Ç–∞–≤–∏–º —Ç–æ–ª—å–∫–æ ip xfrm).

–ü—Ä–∏–º–µ—Ä: –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –º–µ–∂–¥—É DC-RTR –∏ MSK-RTR

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏
ip xfrm state flush
ip xfrm policy flush

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–ª—é—á–∏ –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π PSK)
# –ù–∞ DC-RTR:
ip xfrm state add src <DC_RTR_PUBLIC_IP> dst <MSK_RTR_PUBLIC_IP> proto esp spi 0x100 mode tunnel \
  auth sha256 0x1234567890abcdef1234567890abcdef \
  enc aes 0xabcdef1234567890abcdef1234567890

ip xfrm state add src <MSK_RTR_PUBLIC_IP> dst <DC_RTR_PUBLIC_IP> proto esp spi 0x200 mode tunnel \
  auth sha256 0xabcdefabcdefabcdefabcdefabcdef12 \
  enc aes 0x123456789012345678901234567890ab

ip xfrm policy add src 10.0.0.0/16 dst 192.168.0.0/16 dir out tmpl src <DC_RTR_PUBLIC_IP> dst <MSK_RTR_PUBLIC_IP> proto esp mode tunnel
ip xfrm policy add src 192.168.0.0/16 dst 10.0.0.0/16 dir in tmpl src <MSK_RTR_PUBLIC_IP> dst <DC_RTR_PUBLIC_IP> proto esp mode tunnel

–¢–æ –∂–µ —Å–∞–º–æ–µ –∑–µ—Ä–∫–∞–ª—å–Ω–æ –Ω–∞ MSK-RTR (–º–µ–Ω—è—é—Ç—Å—è src/dst –∏ SPI/–∫–ª—é—á–∏).
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É –ø–æ–¥—Å–µ—Ç—è–º–∏ —à–∏—Ñ—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —è–¥—Ä–∞.


---

2. GRE —Ç—É–Ω–Ω–µ–ª—å (–±–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è, –Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)

GRE –≤—Å—Ç—Ä–æ–µ–Ω –≤ —è–¥—Ä–æ Linux, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–∞–∫–µ—Ç–æ–≤.

–ü—Ä–∏–º–µ—Ä DC-RTR ‚Üî MSK-RTR

# –ù–∞ DC-RTR
ip tunnel add gre1 mode gre remote <MSK_RTR_PUBLIC_IP> local <DC_RTR_PUBLIC_IP> ttl 255
ip addr add 10.10.10.1/30 dev gre1
ip link set gre1 up

# –ù–∞ MSK-RTR
ip tunnel add gre1 mode gre remote <DC_RTR_PUBLIC_IP> local <MSK_RTR_PUBLIC_IP> ttl 255
ip addr add 10.10.10.2/30 dev gre1
ip link set gre1 up

# –ü—Ä–æ–≤–µ—Ä–∫–∞
ping 10.10.10.1 -c3


---

3. GRE + IPsec (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –∫–∞–∫ –∫—Ä–∞–π–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç)

–ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –æ–±–∞ –º–µ—Ö–∞–Ω–∏–∑–º–∞:

1. –ü–æ–¥–Ω–∏–º–∞–µ–º GRE-—Ç—É–Ω–Ω–µ–ª—å (–∫–∞–∫ –≤—ã—à–µ).


2. –î–ª—è –µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (proto 47) –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ç–∏–∫—É IPsec —á–µ—Ä–µ–∑ ip xfrm.



–ü—Ä–∏–º–µ—Ä:

# –®–∏—Ñ—Ä—É–µ–º GRE (proto 47) –º–µ–∂–¥—É —Ä–æ—É—Ç–µ—Ä–∞–º–∏
ip xfrm state add src <DC_RTR_PUBLIC_IP> dst <MSK_RTR_PUBLIC_IP> proto esp spi 0x300 mode transport \
  auth sha256 0x1234567890abcdef1234567890abcdef \
  enc aes 0xabcdefabcdefabcdefabcdefabcdef12

ip xfrm policy add src <DC_RTR_PUBLIC_IP> dst <MSK_RTR_PUBLIC_IP> proto gre dir out tmpl proto esp mode transport
ip xfrm policy add src <MSK_RTR_PUBLIC_IP> dst <DC_RTR_PUBLIC_IP> proto gre dir in  tmpl proto esp mode transport


---

üëâ –†–µ–∑—é–º–µ:

–ù–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: ip xfrm (—á–∏—Å—Ç—ã–π IPsec, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —è–¥—Ä–æ).

–ü—Ä–æ—Å—Ç–æ–π —Ç—É–Ω–Ω–µ–ª—å: GRE (–Ω–æ –±–µ–∑ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è).

–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: GRE + IPsec (—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ + —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å OSPF, multicast).



---

–•–æ—á–µ—à—å, —è —Å–æ–±–µ—Ä—É —Ç–µ–±–µ –≥–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ XFRM (IPsec) –¥–ª—è —Ç—Ä—ë—Ö —É–∑–ª–æ–≤ (DC-RTR, MSK-RTR, RTR-PROD), —á—Ç–æ–±—ã –æ—Å—Ç
–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –≤—Å—Ç–∞–≤–∏—Ç—å IP-–∞–¥—Ä–µ—Å–∞ –∏ –∫–ª—é—á–∏?



–ü–æ–Ω—è–ª üëç
–†–∞–∑ WireGuard –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ø—Ä–µ–¥–ª–∞–≥–∞—é —Ä–∞–∑–æ–±—Ä–∞—Ç—å –¥–≤–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ VPN –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –∞ GRE –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –∫—Ä–∞–π–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:


---

üìå –í–∞—Ä–∏–∞–Ω—Ç—ã VPN –±–µ–∑ WireGuard

1. IPsec (IKEv2) ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–µ—Ç–µ–π

–°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –∏ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ Linux, Cisco, Mikrotik –∏ —Ç.–ø.
–†–µ–∫–æ–º–µ–Ω–¥—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å strongSwan –Ω–∞ Linux-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä–∞—Ö (–∏–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Ç–µ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤).

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ (Debian/Ubuntu):

apt update && apt install -y strongswan strongswan-pki

–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ /etc/ipsec.conf (DC-RTR ‚Üî MSK-RTR)

config setup
  charondebug="ike 2, knl 2, cfg 2"

conn dc-msk
  keyexchange=ikev2
  auto=start
  authby=psk
  left=<DC_RTR_PUBLIC_IP>
  leftsubnet=10.0.0.0/16
  right=<MSK_RTR_PUBLIC_IP>
  rightsubnet=192.168.0.0/16
  ike=aes256-sha2_256-modp2048
  esp=aes256-sha2_256

–ü—Ä–∏–º–µ—Ä –∫–ª—é—á–∞ /etc/ipsec.secrets

<DC_RTR_PUBLIC_IP> <MSK_RTR_PUBLIC_IP> : PSK "–°–ª–æ–∂–Ω—ã–π–ü–∞—Ä–æ–ª—å123!"

–ó–∞–ø—É—Å–∫:

systemctl enable strongswan
systemctl start strongswan
ipsec status


---

2. OpenConnect (ocserv) ‚Äî SSL VPN

–ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è OpenConnect (–ø–æ –∑–∞–¥–∞–Ω–∏—é –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ CLOUD-VM1), –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ –∏ –¥–ª—è —Ç—É–Ω–Ω–µ–ª–µ–π –º–µ–∂–¥—É —Ä–æ—É—Ç–µ—Ä–∞–º–∏.
–ú–∏–Ω—É—Å ‚Äî –Ω–µ –≤—Å–µ–≥–¥–∞ —É–¥–æ–±–Ω–æ –¥–ª—è site-to-site, –Ω–æ —Ä–∞–±–æ—á–∏–π –≤–∞—Ä–∏–∞–Ω—Ç.

–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ /etc/ocserv/ocserv.conf:

auth = "plain[/etc/ocserv/psw-file]"
tcp-port = 443
udp-port = 443
server-cert = /etc/ssl/certs/vpn-cert.pem
server-key = /etc/ssl/private/vpn-key.pem
ipv4-network = 10.55.200.0
ipv4-netmask = 255.255.255.0

–ö–ª–∏–µ–Ω—Ç (–Ω–∞ MSK-RTR):

openconnect -u cod_admin --passwd-on-stdin <DC_RTR_PUBLIC_IP>


---

3. GRE –ø–æ–≤–µ—Ä—Ö IPsec (–∫—Ä–∞–π–Ω–∏–π –≤–∞—Ä–∏–∞–Ω—Ç)

GRE —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ —à–∏—Ñ—Ä—É–µ—Ç —Ç—Ä–∞—Ñ–∏–∫, –ø–æ—ç—Ç–æ–º—É –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–≤–µ—Ä—Ö –Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞—Ç—å IPsec. –≠—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ IP-–ø–∞–∫–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, multicast, OSPF, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã).

GRE —Ç—É–Ω–Ω–µ–ª—å (Linux):

# –ù–∞ DC-RTR
ip tunnel add gre1 mode gre remote <MSK_RTR_PUBLIC_IP> local <DC_RTR_PUBLIC_IP> ttl 255
ip addr add 10.10.10.1/30 dev gre1
ip link set gre1 up

# –ù–∞ MSK-RTR
ip tunnel add gre1 mode gre remote <DC_RTR_PUBLIC_IP> local <MSK_RTR_PUBLIC_IP> ttl 255
ip addr add 10.10.10.2/30 dev gre1
ip link set gre1 up

# –ü—Ä–æ–≤–µ—Ä–∫–∞
ping 10.10.10.1 -c 3

–ó–∞—â–∏—Ç–∞ GRE —á–µ—Ä–µ–∑ IPsec (–¥–æ–±–∞–≤–ª—è–µ–º –≤ /etc/ipsec.conf):

conn gre-protect
  keyexchange=ikev2
  auto=start
  authby=psk
  left=<DC_RTR_PUBLIC_IP>
  right=<MSK_RTR_PUBLIC_IP>
  type=transport
  esp=aes256-sha2_256

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º GRE –ø–æ–ª—É—á–∞–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ IPsec.


---

üëâ –†–µ–∑—é–º–µ:

–û—Å–Ω–æ–≤–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: IPsec (IKEv2) —á–µ—Ä–µ–∑ strongSwan ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: OpenConnect (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å CLOUD-VM1).

–ö—Ä–∞–π–Ω–∏–π —Å–ª—É—á–∞–π: GRE –ø–æ–≤–µ—Ä—Ö IPsec (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –º—É–ª—å—Ç–∏–∫–∞—Å—Ç–∞/OSPF).



---

–•–æ—á–µ—à—å, —è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –≥–æ—Ç–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ IPsec (IKEv2) –∏–º–µ–Ω–Ω–æ –¥–ª—è —Ç—Ä—ë—Ö —É–∑–ª–æ–≤ ‚Äî DC-RTR, MSK-RTR –∏ RTR-PROD —Å –ø—Ä–æ–ø–∏—Å–∞–Ω–Ω—ã–º–∏ left/rightsubnet, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –≤—Å—Ç–∞–≤–∏—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å?





